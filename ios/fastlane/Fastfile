# ios/Fastfile 先頭のほう
require "base64"

default_platform(:ios)

platform :ios do
  desc "CI: build iOS and upload to TestFlight (API Key only)"
  lane :ci_build_testflight do

    # 2) Team を明示（念のため）
    update_project_team(
      path: "App/App.xcodeproj",
      teamid: ENV["APPLE_TEAM_ID"]
    )

    # App Store Connect API Key（Secrets から組み立て）
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: Base64.decode64(ENV["ASC_API_KEY_P8_BASE64"]), # ←ココ必須
      is_key_content_base64: true
    )

    # CocoaPods
    cocoapods(
      clean_install: true,
      podfile: "App/Podfile"
    )

    # 証明書/プロファイルの作成・取得（appstore）
    match(
      type: "appstore",
      readonly: false,
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: ENV["MATCH_GIT_BRANCH"] || "main",
      storage_mode: "git",
      api_key: api_key,                     # ← ここがポイント（セッション不要）
      team_id: ENV["APPLE_TEAM_ID"],
      app_identifier: [ENV["APP_IDENTIFIER"]],
      keychain_name: "login.keychain-db",
      keychain_password: ENV["KEYCHAIN_PASSWORD"] || "temp_keychain_password"
    )

    increment_build_number(
      xcodeproj: "App/App.xcodeproj"
    )

    # === ここから追記（置き換え） ===
    # match が吐いた「BundleID => プロファイル名」のマップから、このアプリのプロファイル名を取得
    profile_name_map = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING] || {}
    app_profile_name = profile_name_map[ENV["APP_IDENTIFIER"]]

    # 推奨アクションで「手動署名＋チーム＋プロファイル名＋配布ID」を明示
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "App/App.xcodeproj",
      targets: ["App"],                               # ターゲット名。違う場合は合わせてください
      team_id: ENV["APPLE_TEAM_ID"],
      code_sign_identity: "Apple Distribution",
      profile_name: app_profile_name                  # ← ここがポイント（名前でOK）
    )

    # 念のため export_options にも指定（既にあればそのままでOK）
    build_app(
      workspace: "App/App.xcworkspace",
      scheme: "App",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => app_profile_name   # "match AppStore <bundle>" の実名が入る
        }
      },
      xcargs: "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']} CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY='Apple Distribution'"
    )
    # === ここまで追記（置き換え） ===

    # TestFlight アップロード（API Key）
    pilot(
      ipa: Actions.lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true,
      notify_external_testers: false,
      api_key: api_key                      # ← ここも API Key
    )
  end
end
