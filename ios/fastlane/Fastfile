default_platform(:ios)

platform :ios do
  desc "CI: build iOS and upload to TestFlight (API Key only)"
  lane :ci_build_testflight do

    # 1) 自動署名をオフ（プロジェクト単位）
    automatic_code_signing(
      use_automatic_signing: false,
      path: "App/App.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"]
    )

    # 2) Team を明示（念のため）
    update_project_team(
      path: "App/App.xcodeproj",
      teamid: ENV["APPLE_TEAM_ID"]
    )

    # 3) Appターゲットの Release に配布プロファイルを固定
    update_project_provisioning(
      xcodeproj: "App/App.xcodeproj",
      target_filter: "App",                  # ターゲット名。違うなら合わせてください
      build_configuration: "Release",
      profile: "match AppStore #{ENV['APP_IDENTIFIER']}",
      code_signing_identity: "Apple Distribution"
    )

    # App Store Connect API Key（Secrets から組み立て）
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_API_KEY_P8"],
      is_key_content_base64: true
    )

    # CocoaPods
    cocoapods(
      clean_install: true,
      podfile: "App/Podfile"
    )

    # 証明書/プロファイルの作成・取得（appstore）
    match(
      type: "appstore",
      readonly: false,
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: ENV["MATCH_GIT_BRANCH"] || "main",
      storage_mode: "git",
      api_key: api_key,                     # ← ここがポイント（セッション不要）
      team_id: ENV["APPLE_TEAM_ID"],
      app_identifier: [ENV["APP_IDENTIFIER"]],
      keychain_name: "login.keychain-db",
      keychain_password: ENV["KEYCHAIN_PASSWORD"] || "temp_keychain_password"
    )

    increment_build_number(
      xcodeproj: "App/App.xcodeproj"
    )

    # 4) 既に入れている build_app は xcargs を強化
    build_app(
      workspace: "App/App.xcworkspace",
      scheme: "App",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => "match AppStore #{ENV["APP_IDENTIFIER"]}"
          "com.test.sampleiosapp" => "match AppStore com.test.sampleiosapp"
        }
      },
      xcargs: "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']} CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY='Apple Distribution'"
    )

    # TestFlight アップロード（API Key）
    pilot(
      ipa: Actions.lane_context[SharedValues::IPA_OUTPUT_PATH],
      skip_waiting_for_build_processing: true,
      notify_external_testers: false,
      api_key: api_key                      # ← ここも API Key
    )
  end
end
